<apex:page controller="PaymentController" docType="html-5.0">
    <!-- Payment Terms: {!activeTerms[0].name}
        Scheduled Payments: -->
    <apex:form id="theForm">
		<style>
	        
	    	body .bPageBlock .pbBody .blue .pbSubheader{
	        	background-color: blue;
			}
	                         
	        .sections {
	            margin: 25px 25px;
	            background: #cafffe;
	        }
	               
	        .sectiontitle {
	            color: black;
	            font-weight: bold;
	            font-size: 125%;
	        }
	               
			.fielderror {
	            color: red;
	            font-style: italic;
	            font-weight: bold;
	        }
	               
	        .container {
	            margin: 5px 5px;
	            height: 100px;
	            background: #cafffe;
	        }
	               
	        .buttonIndent {
	            margin-left: 175px; 
	        }
	               
	        .custPopup {
		        background-color: white;
		        border-width: 5px;
		        border-style: grooved;
		        border-color: blue;
		        z-index: 9999;
		        left: 50%;
		        padding:10px;
		        position: relative;
		        /* These are the 3 css properties you will need to change so the popup 
		        displays in the center of the screen. First set the width. Then set 
		        margin-left to negative half of what the width is. You can add 
		        the height property for a fixed size pop up if you want.*/
		        width: 300px;
		        margin-left: -150px;
		        top:50%;
		        font-weight: bold;
		        text-align: center;
		    }
		    
		    .popupBackground{
		        background-color:black;
		        opacity: 0.20;
		        filter: alpha(opacity = 20);
		        position: absolute;
		        width: 100%;
		        height: 100%;
		        top: 0;
		        left: 0;
		        z-index: 9998;
		    }
		</style>
		
		<apex:pageBlock tabStyle="Opportunity">     
        	<apex:pageMessages id="messages" />
            
            <apex:pageBlockButtons >
                <apex:commandButton value="Process" action="{!process}" onclick="this.style.visibility='hidden';"/>
                <apex:commandButton value="Cancel" action="{!cancel}" immediate="true"  html-formnovalidate="formnovalidate" />
            </apex:pageBlockButtons>
            
            <apex:outputPanel id="approvedDialog">
            	<apex:outputPanel styleClass="popupBackground" layout="block" rendered="{!displayApprovedDlg}"/>
            		<apex:outputPanel styleClass="custPopup" layout="block" rendered="{!displayApprovedDlg}">
                		The transaction for ${!paymentActivity.Amount__c} was APPROVED.<br/><br/>
                		The authorization number is {!paymentActivity.Authorization_Decline_Number__c}.<br/>
                	<apex:commandButton value="OK" action="{!navigateToNext}" rerender="approvedDialog" style="width: 60px; margin-top: 15px; position: relative;" />
            	</apex:outputPanel>
            </apex:outputPanel>
            
            <apex:outputPanel id="declinedDialog">
            	<apex:outputPanel styleClass="popupBackground" layout="block" rendered="{!displayDeclinedDlg}"/>
            		<apex:outputPanel styleClass="custPopup" layout="block" rendered="{!displayDeclinedDlg}">
                		The transaction for ${!paymentActivity.Amount__c} was DECLINED.<br/><br/>
                		The reason reported is {!paymentActivity.Merchant_Error_Text__c}.<br/>
                	<apex:commandButton value="OK" action="{!navigateToNext}" rerender="declinedDialog" style="width: 60px; margin-top: 15px; position: relative;" />
            	</apex:outputPanel>
            </apex:outputPanel>
            
             <apex:outputPanel id="errorDialog">
            	<apex:outputPanel styleClass="popupBackground" layout="block" rendered="{!displayErrorDlg}" />
            		<apex:outputPanel styleClass="custPopup" layout="block" rendered="{!displayErrorDlg}">
                		There was an issue with the response from the merchant account,<br/>
                		however it is likely the payment was approved.<br/><br/>
                		DO NOT RESUBMIT THE CARD FOR PURCHASE!<br/>
                	<apex:commandButton value="OK" action="{!navigateToNext}" rerender="errorDialog" style="width: 60px; margin-top: 15px; position: relative;" />
            	</apex:outputPanel>
            </apex:outputPanel>
            
            <!-- payment info -->
            <apex:outputPanel id="paymentInfo">
            	<apex:pageBlockSection columns="2" title="Payment Information" id="pmtDetails" rendered="{!showPmtInfoSection}" collapsible="false">
                    
                    <apex:inputField value="{!paymentActivity.Payment_Type__c}" onchange="HandlePaymentTypeChange();" />
                    
                    <apex:pageBlockSectionItem rendered="{!showRunMoneyFields}">
                        <apex:outputLabel value="Payment Source" for="pmt_sources" />
                        <apex:selectList id="pmt_sources" multiselect="false" size="1" value="{!selectedPaymentSourceId}">
                            <apex:selectOptions value="{!paymentSources}" />
                            <apex:actionSupport event="onchange" action="{!handlePmtSourceChange}" reRender="paymentInfo" />
                        </apex:selectList>
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem rendered="{!NOT(showRunMoneyFields)}" />
                    
                    <apex:inputField value="{!paymentActivity.Amount__c}" />
                    
                    <apex:pageBlockSectionItem rendered="{!showRunMoneyFields}">
                        <apex:outputLabel value="Process Card?" for="procCardChk" />
                        <apex:inputCheckbox id="procCardChk" value="{!processCard}" onchange="HandlePaymentTypeChange();" />
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem rendered="{!NOT(showRunMoneyFields)}" />
                                        
                    <apex:inputField value="{!paymentActivity.Date__c}" rendered="{!AND(showPaymentInfoFields, allowedProfile)}" />
                    <apex:pageBlockSectionItem rendered="{!NOT(AND(showPaymentInfoFields, allowedProfile))}" />
                    
                    <apex:panelGrid columns="3">
                        <apex:outputPanel style="margin-left: 75px;">
                            <apex:outputLink value="{!newPaymentSourceURL}" target="_blank">Add Payment Source</apex:outputLink>
                        </apex:outputPanel>
                        <apex:outputPanel style="margin-left: 15px;" rendered="{!enableEditPaymentSource}">
                            <apex:outputLink value="{!editPaymentSourceURL}" target="_blank">Edit Payment Source</apex:outputLink>
                        </apex:outputPanel>
                        <apex:outputPanel style="margin-left: 15px;" rendered="{!showRunMoneyFields}">
                            <apex:commandLink value="Refresh Payment Sources" action="{!refreshPaymentSources}" rerender="theForm" />
                        </apex:outputPanel>
                    </apex:panelGrid>
                    <apex:pageBlockSectionItem rendered="{!NOT(showPaymentInfoFields)}" />
                    
                    <apex:inputField value="{!paymentActivity.Authorization_Decline_Number__c}" rendered="{!AND(showPaymentInfoFields, allowedProfile)}" />
                    <apex:pageBlockSectionItem rendered="{!NOT(AND(showPaymentInfoFields, allowedProfile))}" />
                    
                    <apex:pageBlockSectionItem />
                    
                    <apex:inputField value="{!paymentActivity.Outcome__c}" rendered="{!AND(showPaymentInfoFields, allowedProfile)}" />
                    <apex:pageBlockSectionItem rendered="{!NOT(AND(showPaymentInfoFields, allowedProfile))}" />
                    
                    <apex:pageBlockSectionItem />
                    
                    <apex:inputField value="{!paymentActivity.Payment_Status__c}" rendered="{!AND(showPaymentInfoFields, allowedProfile)}" />
                    <apex:pageBlockSectionItem rendered="{!NOT(AND(showPaymentInfoFields, allowedProfile))}" />
                    
                    <apex:pageBlockSectionItem />
                    
                    <!--        <apex:inputField value="{!paymentActivity.Payment_Activity_Type__c}"/>    -->
                    
                    <apex:inputField value="{!paymentActivity.Processed_By__c}" rendered="{!AND(showPaymentInfoFields, allowedProfile)}" />
                    <apex:pageBlockSectionItem rendered="{!NOT(AND(showPaymentInfoFields, allowedProfile))}" />
                    
                </apex:pageBlockSection>
            </apex:outputPanel>
            
            
            <!-- pending payments -->
            <apex:outputPanel id="pendingPayments" rendered="{!AND(enablePendingPayments, allowedProfile)}">
            	<apex:pageBlockSection columns="1" title="Pending Payments">
	                <apex:outputPanel rendered="true" id="activitiesPanel">
	                    <apex:pageBlockTable value="{!paymentActivityWrapList}" var="pendPmt">
	                        <apex:column width="15px" headervalue="Selected">
	                            <apex:inputCheckbox value="{!pendPmt.Selected}" onclick="HandleSelectionChange();" disabled="{!NOT(hasPlannedPayments)}" />
	                        </apex:column>
	                        <apex:column width="200px" headervalue="Date">
	                            <apex:outputText value="{!pendPmt.paymentActivity.Date__c}" />
	                        </apex:column>
	                        <apex:column width="200px" headervalue="Amount">
	                            <apex:outputText value="{!pendPmt.paymentActivity.Amount__c}" />
	                        </apex:column>
	                        <apex:column width="200px" headervalue="Outcome">
	                            <apex:outputText value="{!pendPmt.paymentActivity.Outcome__c}" />
	                        </apex:column>  
	                    </apex:pageBlockTable>
	                </apex:outputPanel>
	                <apex:outputPanel id="activitiesInfo" rendered="{!enablePendingPayments}" >
	                    <apex:outputLabel style="font-size: medium;" id="totalLabel" rendered="{!hasPaymentActivities}">
	                        TOTAL SELECTED PAYMENTS: ${!totalSelectedPayments}
	                    </apex:outputLabel>
	                    <apex:outputLabel style="font-size: medium;" rendered="{!NOT(hasPaymentActivities)}">
	                        There are no unassigned payment activities. 
	                    </apex:outputLabel>
	                </apex:outputPanel>
	            </apex:pageBlockSection>
            </apex:outputPanel>
            
            
            <!-- planned payments -->
            <apex:outputPanel id="plannedPayments">
            	<apex:pageBlockSection columns="1" title="Planned Payments" rendered="{!hasPlannedPayments}">
                    <apex:pageBlockTable value="{!plannedPaymentWraps}" var="p" id="table">
                        <apex:column value="{!p.payment.Due_Date__c}" />
                        <apex:column value="{!p.payment.Due__c}" />
                        <apex:column headerValue="PP Amount Paid">
                            <apex:inputText value="{!p.amount}" rendered="{!AND(allowedProfile, NOT(runMoneyMode))}" />
                            <apex:outputText value="{!p.amount}" rendered="{!OR(NOT(allowedProfile), runMoneyMode)}" />
                        </apex:column>
                        <apex:column headerValue="PP Status">
                            <apex:inputField value="{!p.payment.Status__c}" rendered="{!AND(allowedProfile, NOT(runMoneyMode))}" />
                            <apex:outputField value="{!p.payment.Status__c}" rendered="{!OR(NOT(allowedProfile), runMoneyMode)}" />
                        </apex:column>
                        <apex:column headerValue="Override Status">
                            <apex:inputCheckBox value="{!p.overRideStatus}" disabled="{!OR(NOT(allowedProfile), runMoneyMode)}" />
                        </apex:column>
                    </apex:pageBlockTable>
                </apex:pageBlockSection>
            </apex:outputPanel>
            
        </apex:pageBlock>
        
        <apex:actionFunction name="HandlePaymentTypeChange" action="{!handlePaymentTypeChange}" rerender="theForm, plannedPayments" />
        <apex:actionFunction name="HandleSelectionChange" action="{!handleSelectionChange}" rerender="paymentInfo, pmtDetails, pendingPayments" />
    </apex:form>
</apex:page>